# 要件定義書（完全版 v1.2）

**プロジェクト名**：Personal Gateway Site（Notion風）  
**対象工程**：要件定義（設計直前の仕様確定）  
**根拠**：要求定義 v1.1／Station 初級編教科書  
**目的**：この文書どおり作れば DOD を満たす

---

## 0. 変更要約（v1.2）

- **リンク集を3点に集約**：GitHub / LinkedIn / Email のみ（SNS系は除外）。
    
- 試験観点・アクセシビリティ表現を微調整（フォーカス順序、ラベル判別）。
    
- そのほかの章は v1.1R を踏襲（数値基準・SOP・コスト境界は維持）。
    

---

## 1. スコープ（Scope）

### 1.1 In-Scope（PoC 到達点）

- 画面：トップ／リンク集（3点）／問い合わせフォーム／404／500／`/health`
    
- **独自ドメイン + HTTPS**（ALB + ACM）／モバイル・PC 対応
    
- **問い合わせ → RDS 保存**（保持 90 日、自動削除）
    
- **最低限の解析**（日次 UU・日次 PV・流入上位 5 を**週1で閲覧可能**）
    
- **運用 SLO**：`main` マージ→本番反映 ≤10 分、失敗→直前版復帰 ≤10 分
    
- コスト：**月上限 USD 10**、**80% 到達で通知**必須
    
- ドキュメント：`/docs/` に構成図・結果・手順・費用を集約
    

### 1.2 Out-of-Scope（今回やらない）

- 会員・認証、決済、CMS、全文検索、多言語、商用 SLA、多段環境（stg/prod）
    
- 多AZ冗長化、APM/分散トレース、NAT Gateway 構成
    
- ページネーションを要する検索系機能（本プロダクトに該当機能なし）
    

---

## 2. システム方式（How：骨格）

- **アーキ**：ALB(443) → EC2(80) → RDS(PostgreSQL, Private)
    
- **リージョン**：ap-northeast-1（東京）
    
- **OS/ランタイム**：Amazon Linux 2023 / Node.js 20 LTS
    
- **ネットワーク**：VPC 10.10.0.0/16、Public（ALB/EC2）/ Private（RDS）
    
- **管理**：SSM Session Manager（SSH 不可）／NAT なし
    
- **CI/CD**：GitHub Actions → SSM Send-Command（artifact 展開→再起動）
    

---

## 3. 機能要件（Functional Requirements）

|ID|機能|仕様（要件）|受け入れ観点|
|---|---|---|---|
|**F-01**|トップ表示|`https://www.<my-domain>/` にプロフィール要点＋主 CTA（GitHub／LinkedIn／Email のいずれか）。|200 応答／主要 CTA から**1クリック**で遷移できる。|
|**F-02**|リンク集（3点）|**GitHub／LinkedIn／Email** の3リンクのみ。PCは横並び、モバイルは縦並び。各リンクは**アイコン+テキスト**の判別可能ラベル。・GitHub/LinkedIn は**新規タブ**・Email は `mailto:`（件名にサイト名を含める）・キーボード操作で **GitHub→LinkedIn→Email** の順にフォーカス遷移。|目視で3リンクのみ／**Tab**で所定順序にフォーカス／GitHub/LinkedIn は新規タブ起動、Email はメーラー起動（件名入り）。|
|**F-03**|問い合わせ|**POST `/api/contact`**：`email(形式)` `body(≤1000)` `name(≤50任意)` `consent(true)`／**RDS 1 行保存**／項目別エラー返却／**Turnstile サーバー検証**必須。|201 で RDS 1 行／不正は 400 + `fieldErrors`。|
|**F-04**|ヘルス|**GET `/health`** → `200 {"status":"ok"}`。|ALB 経由で 200。|
|**F-05**|解析|GA4 で**日次 UU・日次 PV・流入上位 5**を**週 1 で閲覧可能**。|`/docs/analytics/` に週次証跡。|
|**F-06**|エラーページ|404/500 の体裁。|不正 URL→404、意図的例外で 500 表示。|

**API 契約（F-03）**

- 入力：JSON `email`, `body`, `name?`, `consent`（true）
    
- 返却：201 `{ id, storedAt }` / 400 `{ fieldErrors }`
    
- Bot：Cloudflare Turnstile の**サーバー検証**（失敗時 400）
    

**DB スキーマ（F-03）**

```sql
CREATE TABLE inquiries(
  id BIGSERIAL PRIMARY KEY,
  email VARCHAR(254) NOT NULL,
  body TEXT NOT NULL CHECK (char_length(body) <= 1000),
  name VARCHAR(50),
  consent BOOLEAN NOT NULL,
  user_agent VARCHAR(255),
  referer VARCHAR(255),
  created_at TIMESTAMPTZ DEFAULT now()
);
CREATE INDEX idx_inquiries_created_at ON inquiries(created_at);
```

---

## 4. 非機能要件（NFR：数値・状態で固定）

|区分|要件|
|---|---|
|**セキュリティ**|常時 HTTPS／RDS PublicAccess=false／秘密情報は **SSM Parameter Store**／**SSH 無効・SSM のみ**／Turnstile 必須／`CSP: default-src 'self'`（GA4/Turnstile 最小許可）／`HSTS: max-age=31536000; includeSubDomains`／`X-Content-Type-Options: nosniff`|
|**可用性**|単一 EC2。**ALB Target Healthy=1** を維持|
|**性能**|Lighthouse(Desktop) **Performance 80+**、CLS<0.1、JS バンドル目安 < 300KB|
|**運用 SLO**|`main`→本番反映 ≤10 分／失敗→直前版復帰 ≤10 分（手順の実証を要す）|
|**観測性**|アプリ/アクセス最小ログを **CloudWatch Logs 30 日保持**|
|**コスト**|**月上限 USD 10**／**80% 通知**（AWS Budgets）|
|**法令/規約**|プライバシーポリシー掲出・同意取得必須（収集目的/項目/保持/削除窓口/第三者提供）|
|**アクセシビリティ**|Tab で主要導線に到達／画像 `alt` 必須／**コントラスト比 4.5:1 以上**|

---

## 5. デザイン要件（Notion風の客観化）

- 配色：白地＋黒/グレー、アクセント 1 色以内（トークン化）
    
- 余白：上下 **≥80px**、左右 **≥32px**
    
- タイポ：見出し 600+、本文 line-height ≈ 1.6
    
- 線：**1px ボーダー**のみ、アイコンは最小限
    
- 動き：opacity/transform 中心、**≤300ms**、パララックス禁止
    
- レスポンシブ：**360 / 768 / 1280** の 3 幅で崩れ無し（比較キャプチャ）
    

---

## 6. 詳細構成

- **VPC**：`10.10.0.0/16`
    
- **Public Subnet**：`10.10.10.0/24`（ALB/EC2）×2 AZ 予約（a/c）
    
- **Private Subnet**：`10.10.20.0/24`（RDS）
    
- **IGW**：あり（ALB/EC2）／**NAT：なし**
    
- **SG-ALB**：In 80/443: `0.0.0.0/0`、Out → EC2
    
- **SG-APP**：In 80: from SG-ALB、SSM（ポート開放不要）、Out → RDS:5432 / HTTPS
    
- **SG-DB**：In 5432: from SG-APP、PublicAccess=false
    
- **ACM**：東京リージョンで DNS 検証（`www.<my-domain>` もしくは `*. <my-domain>`）
    
- **EC2**：`t3.micro`、Amazon Linux 2023、Auto-Recovery 有効、`systemd` 管理
    
- **RDS**：PostgreSQL 16、`db.t3.micro`、20GB gp3、Single-AZ、自動バックアップ 1 日
    
- **秘密情報**：SSM Parameter Store `/gateway/prod/*` で供給
    

---

## 7. 運用要件 / SOP

- **CI/CD**：GitHub Actions → `aws ssm send-command` で EC2 の `/opt/gateway/deploy.sh` を実行（artifact 展開→`systemctl restart gateway`）
    
- **ロールバック**：`/opt/ggateway/releases` に直近 2 版保持→失敗時自動で直前版へ symlink 切替
    
- **起動/停止**：`systemctl start|stop|restart gateway`
    
- **疎通順**：ALB(443) → EC2(80) → RDS(5432)
    
- **片付け順**：ALB → EC2 → RDS（必要ならスナップショット）→ ACM → Route53
    

---

## 8. セキュリティ実装要件（抜粋）

- **CSP** 最小許可（自己ドメイン + GA4 + Turnstile のみ）
    
- **HSTS** 有効化、`nosniff` 付与
    
- **SSM 管理**（SSH 鍵禁止）、`.env` 直置き禁止
    
- **RDS** は EC2 SG のみ許可、パブリック不可
    
- **Turnstile** 検証失敗時は保存処理に到達させない（早期 400）
    

---

## 9. 受け入れ試験（テーブル定義／PowerShell 手順）

| 手順例（PowerShell）                                                               | 観点          | 合格                                                                                                                                      |
| ----------------------------------------------------------------------------- | ----------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| `(Invoke-WebRequest https://www.<my-domain>/ -UseBasicParsing).StatusCode`    | トップ 200     | 200                                                                                                                                     |
| 目視（GitHub/LinkedIn/Email のいずれかに 1 クリックで遷移）                                    | CTA 1クリック導線 | OK                                                                                                                                      |
| 目視で **3 つのみ**表示。`Tab` で **GitHub→LinkedIn→Email** に移動。                        | リンク集（3点のみ）  | OK                                                                                                                                      |
| GitHub/LinkedIn は新規タブ、Email はメーラー起動（件名入り）                                     | 新規タブ/メーラー   | OK                                                                                                                                      |
| ``$b=@{email="[a@b.com](mailto:a@b.com)";body="hi";consent=$true}             | 問い合わせ 正常    | ConvertTo-Json; Invoke-RestMethod -Method Post -Uri [https://www](https://www/)./api/contact -ContentType "application/json" -Body $b`` |
| メール不正や consent=false を送る                                                      | 問い合わせ 異常    | 400 & `fieldErrors`                                                                                                                     |
| `(Invoke-WebRequest https://www.<my-domain>/health -UseBasicParsing).Content` | ヘルス         | `{"status":"ok"}`                                                                                                                       |
| GA4 画面を `/docs/analytics/` に保存                                                | 解析 週次       | 3 指標閲覧可                                                                                                                                 |
| ブラウザで鍵マーク                                                                     | TLS         | 有効                                                                                                                                      |
| 実測                                                                            | Lighthouse  | Desktop 80+                                                                                                                             |
| `main`→反映まで計測                                                                 | デプロイ SLO    | ≤10 分                                                                                                                                   |
| 意図的失敗→自動ロールバック                                                                | 復帰 SLO      | ≤10 分                                                                                                                                   |
| Budgets テスト通知                                                                 | コスト通知       | 80% 通知受領                                                                                                                                |

---

## 10. 自動ジョブ

- **日次 04:00 JST**：`DELETE FROM inquiries WHERE created_at < now() - interval '90 days';`（削除件数をログ出力）
    
- **週次 月曜 09:00 JST**：GA4 確認→`/docs/analytics/` にキャプチャ（手動でも可：**週1閲覧可能**を満たせば合格）
    

---

## 11. IAM（最小権限）

- **EC2 実行ロール**：`AmazonSSMManagedInstanceCore` / Parameter Store（`/gateway/prod/*` 読取）/ CloudWatch Logs 出力
    
- **GitHub OIDC ロール**：`ssm:SendCommand`（**タグで対象 EC2 を限定**）＋（必要時）S3:GetObject
    

---

## 12. 環境変数（Parameter Store）

|Key|用途|
|---|---|
|`/gateway/prod/DB_HOST` `DB_USER` `DB_PASS` `DB_NAME`|RDS 接続情報|
|`/gateway/prod/TURNSTILE_SECRET`|Bot 検証|
|`/gateway/prod/GA4_ID`|解析|

---

## 13. 図解（ASCII）

```
Internet
   |
 [ALB:443] -- ACM
   | (SG: ALB→APP:80)
 [EC2:80]  (Public Subnet)
   | 5432
 [RDS:PostgreSQL] (Private, Non-Public)
```

---

## 14. 成果物（/docs に保存）

- `arch.png|drawio`（論理図）
    
- 画面スクショ（トップ／リンク集／404／500／Lighthouse 結果）
    
- 受け入れ試験ログ（上記コマンド出力・確認キャプチャ）
    
- `analytics/`（週次 KPI）／`costs/yyyymm.md`（月次概算）
    
- SOP（起動/停止/復旧/片付け、DNS/ACM 手順図）
    

---

## 15. マイルストーン

1. ドメイン + TLS 通過（`/health` 可視化）
    
2. 問い合わせ → RDS 保存（90 日ルール実装）
    
3. CI/CD（SSM）＋ロールバック実証
    
4. 解析/費用/SOP の証跡集約
    
